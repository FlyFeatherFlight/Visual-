@model  ChicST_MM.WEB.Models.BusinessTripViewModel
@if (ViewBag.IsEdit == true)
{
    {
        ViewBag.Title = "出差记录修改";

    }
    <h3>出差记录修改</h3>
    @Html.ActionLink("查看汇报", "BusinessTrip_RportListView", new { tripID = Model.ID }, new { style = "margin-left:2.5%;" })
    <form id="myFormE">
        <input type="text" name="ID" value="@Model.ID" class="hidden" />
        <table class="table table-striped table-bordered table-hover">
            <tr>
                <td colspan="7" style="position:relative;">
                    <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12 start-date">
                        <span class="bold">开始日期</span>&nbsp;&nbsp;
                        <input name="开始时间" class="search-input  red dateTime " value="@Model.开始时间.ToString("yyyy-MM-dd")" type='text' placeholder="请选择开始日期" oninput="sureRed()" readonly />
                        <span class="must" style="color:red;">*该项为必填项</span>
                    </div>

                    <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
                        <span class="bold">结束日期</span>&nbsp;&nbsp;
                        <input name="结束时间" class="search-input dateTime red  " value="@Model.结束时间.ToString("yyyy-MM-dd")" type='text' placeholder="请选择结束日期" oninput="sureRed()" readonly />
                        <span class="must" style="color:red;">*该项为必填项</span>
                    </div>
                </td>
            </tr>
            <tr>
                <td class="bold">关联审核人</td>
                <td colspan="6">
                    <select name="关联审核人ID" id="reviewer" class="form-control red " oninput="sureRed()">
                        <option value="@Model.关联审核人ID">@Model.关联审核人</option>
                    </select>
                    <span class="must" style="color:red;">*该项为必填项</span>
                </td>
            </tr>
            <tr>
                <td class="bold">出差内容</td>
                <td colspan="6">
                    <textarea rows="3" class="form-control red" name="出差内容" oninput="sureRed()">@Model.出差内容</textarea>
                    <span class="must" style="color:red;">*该项为必填项</span>
                </td>
            </tr>
            <tr>
                <td class="bold">备注</td>
                <td colspan="6">
                    <input type="text" class="form-control" name="备注" value="@Model.备注" />
                </td>
            </tr>
            <tr>
                <td class="bold" rowspan="3">费用预估</td>
            </tr>
            <tr>
                <td>车船费预计</td>
                <td>
                    <input type="text" name="车船费预计" value="@Model.车船费预计" class="form-control" id="fare"
                           onkeyup="value=value.replace(/[^\d.]/g,'')"
                           onblur="value=value.replace(/[^\d.]/g,'')" oninput="priceTotal()" />
                </td>
                <td>住宿费预计</td>
                <td>
                    <input type="text" name="住宿费预计" value="@Model.住宿费预计" class="form-control" id="room"
                           onkeyup="value=value.replace(/[^\d.]/g,'')"
                           onblur="value=value.replace(/[^\d.]/g,'')" oninput="priceTotal()" />
                </td>
                <td>餐补费预计</td>
                <td>
                    <input type="text" name="餐补费预计" value="@Model.餐补费预计" class="form-control" id="eat"
                           onkeyup="value=value.replace(/[^\d.]/g,'')"
                           onblur="value=value.replace(/[^\d.]/g,'')" oninput="priceTotal()" />
                </td>
            </tr>
            <tr>
                <td>合计</td>
                <td colspan="5">
                    <input type="text" name="合计" class="form-control total" value="@Model.合计" readonly />
                </td>
            </tr>
            <tr>
                <td class="bold">审核状态</td>
                <td colspan="10">

                    @if (Model.审核状态 == true)
                    {
                        <span>通过</span>
                    }
                    else if (Model.审核状态 == false)
                    {
                        <span>驳回</span>
                    }
                    else
                    {
                        <span>未审核</span>
                    }
                </td>
            </tr>
        </table>
        @Html.Action("AddBusinessTrip_DetailsView", "BusinessTrip", new { id = Model.ID, isDetail = false, isEdit = true })

        <div class="submit-btns" style="margin-top:10px;">
            <input type="button" value="保存修改" class="btn btn-success width-7" onclick="myFormE()">
            &nbsp;&nbsp;
            <input type="button" value="取消" class="btn btn-danger width-7" onclick="javascript:history.back(-1);">
        </div>
    </form>
    @**添加模态框*@
    <div id="dialog-form" style="text-align:center;">
        @*添加出差计划详情*@
        <form id="addForm" style="position:relative;">
            <input type="text" value="@Model.ID" name="出差记录ID" class="hidden"/>
            <div class="mask hidden"></div>
            <table class="table table-striped table-bordered table-hover" id="TabF">

                <tr>
                    <td>城市</td>
                    <td>
                        <select id="sheng" class="search-input">
                            <option value="" class="active">-请选择省-</option>
                        </select>
                        <select id="shi" class="search-input red" style="margin-top:5px;" name="城市ID">
                            <option value="">-请选择市-</option>
                        </select>
                        <span class="must" style="color:red;">*该选项为必填项</span>

                    </td>
                    <td>出差时间</td>
                    <td width="35%">
                        <input type="text" name="出差时间" class="dateTime form-control red" placeholder="请选择日期" onclick="sureRed()" readonly />
                        <span class="must" style="color:red;">*该选项为必填项</span>
                    </td>

                </tr>
                <tr>
                    <td>同行人</td>
                    <td colspan="3">
                        <input type="text" class="form-control " name="同行人员" />

                    </td>
                </tr>

                <tr>
                    <td style="vertical-align: top">巡店目的</td>
                    <td colspan="3">
                        <textarea type="text" class=" form-control " name="巡店目的" placeholder="最多填写250个字" rows="3"></textarea>

                    </td>
                </tr>
                <tr>
                    <td style="vertical-align: top">计划方案</td>
                    <td colspan="3">
                        <textarea type="text" class=" form-control" name="计划方案" placeholder="最多填写250个字" rows="3"></textarea>

                    </td>
                </tr>
                <tr>
                    <td style="vertical-align: top">计划内容</td>
                    <td colspan="3">
                        <textarea type="text" class=" form-control" name="计划内容" placeholder="最多填写250个字" rows="3"></textarea>

                    </td>
                </tr>
                <tr>
                    <td>备注</td>
                    <td colspan="3">
                        <input type="text" class="form-control" name="备注" />
                    </td>
                </tr>
            </table>
            <div class="submit-btns">
                <input type="button" name="" value="提交" class="btn btn-success" id="addForm-btn" />
            </div>
        </form>
        @*拜访对象*@
        <form id="Type" class="hidden">
            <input type="text" name="name" value="" id="TypeId" class="hidden" />
            <table class="table table-bordered" id="Tab">
                <thead>
                    <tr>
                        <th style="width:42%;">拜访对象类型</th>
                        <th>拜访对象</th>
                        <th>
                            操作

                        </th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <input type="button" name="name" value="添加" class="btn btn-primary" onclick="addTr()" />
            <input type="button" name="name" value="提交" class="btn btn-success" onclick="TypeSub()" />
        </form>
    </div>
    @*修改计划详情模态框*@
    <div id="dialog-formE">
        @*修改出差计划详情*@
        <form id="editForm" style="position:relative;">
            <input type="text" value="" name="出差记录ID" id="editId" class="hidden" />
            <input type="text" value="" name="ID" id="planId" class="hidden" />
            <table class="table table-striped table-bordered table-hover">

                <tr>
                    <td>城市</td>
                    <td>
                        @*<select id="shengE" class="search-input">
                                <option value="" class="active">-请选择省-</option>
                            </select>
                            <select id="shiE" class="search-input" style="margin-top:5px;" name="">
                                <option value="">-请选择市-</option>
                            </select>*@
                        <div id="lastCity">
                            <span></span>
                            <input type="text" name="城市ID" value="" class="hidden" />
                        </div>

                    </td>
                    <td>出差时间</td>
                    <td width="35%">
                        <input type="text" name="出差时间" id="CdateE" class="dateTime form-control red" placeholder="请选择日期" onclick="sureRed()" readonly />
                        <span class="must" style="color:red;">*该选项为必填项</span>
                    </td>

                </tr>
                <tr>
                    <td>同行人</td>
                    <td colspan="3">
                        <input type="text" id="personE" class="form-control " name="同行人员" />

                    </td>
                </tr>

                <tr>

                    <td style="vertical-align: top">巡店目的</td>
                    <td colspan="3">
                        <textarea type="text" id="visitAimE" class=" form-control " name="巡店目的" placeholder="最多填写250个字" rows="3"></textarea>

                    </td>
                </tr>
                <tr>
                    <td style="vertical-align: top">计划方案</td>
                    <td colspan="3">
                        <textarea type="text" id="workPlanE" class=" form-control" name="计划方案" placeholder="最多填写250个字" rows="3"></textarea>

                    </td>
                </tr>
                <tr>
                    <td style="vertical-align: top">计划内容</td>
                    <td colspan="3">
                        <textarea type="text" id="workContentE" class=" form-control" name="计划内容" placeholder="最多填写250个字" rows="3"></textarea>

                    </td>
                </tr>
                <tr>
                    <td>备注</td>
                    <td colspan="3">
                        <input type="text" id="notesE" class="form-control" name="备注" />
                    </td>
                </tr>
            </table>
        </form>
    </div>
    @*行内添加拜访对象*@
    <form id="addType-dialog">
        <input type="text" name="" value="" id="TypeAplanId" class="hidden" />
        <input type="text" name="" value="" id="TypeAId-city" class="hidden" />
        <table class="table table-bordered">
            <tr>
                <td>对象类型</td>
                <td>
                    <select id="TypeA" class="form-control" onchange="chooseObjA(this)">
                        <option value="">-请选择-</option>
                        <option value="商场">商场</option>
                        <option value="门店">门店</option>
                        <option value="经销商">经销商</option>
                    </select>
                </td>
            </tr>
            <tr>

                <td>对象名称</td>
                <td>
                    <select class="form-control" id="ObjName">
                        <option value="">-请选择-</option>

                    </select>
                </td>
            </tr>
        </table>

    </form>
    @*行内修改拜访对象*@
    <form id="editType-dialog">
        <input type="text" name="出差计划详细ID" value="" id="TypeAplanIdE" class="hidden" />
        <input type="text" name="ID" value="" id="visitTypeIdE" class="hidden" />
        <input type="text" name="" value="" id="TypeAId-cityE" class="hidden" />
        <table class="table table-bordered">
            <tr>
                <td>对象类型</td>
                <td>
                    <select id="TypeE" name="拜访对象类型" class="form-control" onchange="chooseObjE(this)">
                        <option value="">-请选择-</option>
                        <option value="商场">商场</option>
                        <option value="门店">门店</option>
                        <option value="经销商">经销商</option>
                    </select>
                </td>
            </tr>
            <tr>

                <td>对象名称</td>
                <td>

                    <select class="form-control" id="ObjNameE">
                        <option value="">-请选择-</option>
                    </select>
                    <div id="lastObjName">
                        上次选中的对象是：
                        <span></span>
                        <input type="text" name="拜访对象ID" value="" class="" />
                    </div>
                </td>
            </tr>
        </table>

    </form>
    <script>
        // 修改主表
        function myFormE() {
            // 判断表格中必填项是否为空
            var status = false;
            $("#myFormE .red").each(function (i, m) {

                if (m.value == null || m.value == "") {
                    return status = true;
                }
            })
            if (status) {
                alert("请先完善信息!");
                return;
            } else {
                $.ajax({
                    type: "post",
                    data: $("#myFormE").serialize(),
                    url: '@Url.Action("BusinessTripEdit", "BusinessTrip")',
                    dataType: "json",
                    cache: false,
                    async: true,
                    success: function (data) {
                        if (data.success) {
                            alert(data.msg + "，跳转至详情！");
                            window.location.href="@Url.Action("BusinessTrip_DetailsView", "BusinessTrip")?id="+@Model.ID;

                        } else {
                            alert(data.msg);
                        }
                    },
                    error: function (err) {
                        alert("点击过快或网络错误，请稍后重试！")
                    }


                })
            }
        }
        // 费用预估合计
        function priceTotal() {
            var fare = $("#fare").val();
            var room = $("#room").val();
            var eat = $("#eat").val();
            var total = 0
            total = parseFloat(fare) + parseFloat(room) + parseFloat(eat);
            $(".total").val(total)

        }

    //转换日期格式
    var dates = $("#Table .date");
    $(dates).each(function (i, m) {
        if (m != null || m != "") {

            var strTime = $(m).text();
            strTime = strTime.split("/周");
            strTime = strTime[0];
            $(m).text(strTime);
        }
    })
    // 配置对话框(使用Jquery-UI的dialog插件)
    $('#dialog-form').dialog({ title: '出差行程计划详细内容' }).dialog("close");

    //配置模态框
    $("#dialog-form").dialog({
        autoOpen: false,
        height: 800,
        width: 960,
        modal: true,
        buttons: {

            "取消": function () { $(this).dialog("close") },
            "确认": function () {
                $("#addForm .mask").addClass("hidden");
                $("#Type").addClass("hidden");
                $("#dialog-form").dialog("close");
                window.location.reload();
            }
        }
    });
    // 点击添加打开模态框
    $("#create-user").click(function () {
            $("#dialog-form").dialog("open");
        });
    //详细内容提交
    $("#addForm-btn").click(function () {
        var statusD = false;

        $("#TabF .red").each(function (i, m) {

            if (m.value == "" || m.value == null) {

                return statusD = true;
            }
        })
      if (statusD) {
          alert("必填项不能为空！");
        }else {
            //提交模态框的数据
          $.ajax({
              url: '@Url.Action("BusinessTrip_DetailsAdd","BusinessTrip")',
              type: "post",   //默认为get
              data: $("#addForm").serialize(),   //传递给服务端的数据
                dataType: "json",
                cache: false,
                success: function (data, textStatus) {
                    console.log(data)
                    // 如果提交成功就显示在页面
                    if (data.Success) {
                        $("#addForm .mask").removeClass("hidden");
                        $("#Type").removeClass("hidden");
                        $("#TypeId").val(data.businessid);
                        alert("添加成功，请添加拜访对象！");

                    } else {
                        alert("添加失败!");
                        console.log(data.msg);
                    }

                },
                error: function (textStatus, errorThrown) {
                    console.log("系统ajax交互错误: " + JSON.stringify(textStatus));
                },
            });
        }
    })
    //拜访对象提交
    function TypeSub() {
        var trs = document.getElementById("Tab"),
            datas = [];

        for (var i = 1; i < trs.rows.length; i++) {

            var objDate = {
                "出差计划详细ID": $("#TypeId").val(),
                "拜访对象类型": trs.rows[i].cells[0].getElementsByTagName("select")[0].value,
                "拜访对象ID": trs.rows[i].cells[1].getElementsByTagName("select")[0].value,

            }
            datas.push(objDate);

        }

        $.ajax({
            url: '@Url.Action("BusinessTrip_VisitSubjectAdd", "BusinessTrip")',
            type: "post",   //默认为get
            data: {lis:JSON.stringify(datas)},   //传递给服务端的数据
            dataType: "json",
            cache: false,
            success: function (data, textStatus) {
                console.log(data)
                // 如果提交成功就显示在页面
                if (data.success) {
                    alert(data.msg);
                    $("#dialog-form").dialog("close");
                    window.location.reload();
                } else {
                    alert("添加失败!");
                    console.log(data.msg);
                }

            },
            error: function (textStatus, errorThrown) {
                console.log("系统ajax交互错误: " + JSON.stringify(textStatus));
            },
        });

    }

    //添加拜访对象行
    function addTr() {
        var tr = ` <tr>
                <td>
                    <select class="Type form-control" onchange="chooseObj(this)">
                        <option value="">-请选择-</option>
                        <option value="商场">商场</option>
                        <option value="门店">门店</option>
                        <option value="经销商">经销商</option>
                    </select>
                </td>
                <td>
                    <select class="visitObj form-control">
                        <option value="">-请选择-</option>
                    </select>
                </td>
                <td><span class="Aspan" onclick="Del(this)">删除</span></td>
            </tr>`;
        $("#Type tbody").append(tr);
    }
    //删除拜访对象行
    function Del(_this) {
        $(_this).parent().parent().remove();
    }
    //行内添加拜访对象模态框配置
    $("#addType-dialog").dialog({
        autoOpen: false,
        height: 300,
        width: 400,
        modal: true,
        buttons: {

            "取消": function () { $(this).dialog("close") },
            "确认": function () {
                var datas = [
                    {

                        "出差计划详细ID": $("#TypeAplanId").val(),
                        "拜访对象类型": $("#TypeA").val(),
                        "拜访对象ID": $("#ObjName").val()
                    },
                ];
        $.ajax({
                type: "post",
                data: { lis: JSON.stringify(datas) },
                url: '@Url.Action("BusinessTrip_VisitSubjectAdd", "BusinessTrip")',
                dataType: "json",
                cache: false,
                async: true,
                success: function (data) {
                    if (data.success) {
                        alert(data.msg);
                        $("#addType-dialog").dialog("close");
                        window.location.reload();
                    } else {
                        alert(data.msg);
                    }
                    //console.log(data);
                },
                error: function (err) {
                    alert("点击过快或网络错误，请稍后重试！");;
                    console.log(err);
                }

            })

            }
        }
    });
    //行内添加拜访对象
    function addType(_this) {
        var cityid = $.trim($(_this).parent().siblings(".cityId").text());
        var id = $.trim($(_this).parent().siblings(".planId").text());
        $("#TypeAId-city").val(cityid);
        $("#TypeAplanId").val(id);
        $("#addType-dialog").dialog("open");
    }
    //行内修改拜访对象模态框配置
    $("#editType-dialog").dialog({
        autoOpen: false,
        height: 300,
        width: 400,
        modal: true,
        buttons: {

            "取消": function () { $(this).dialog("close") },
            "确认": function () {

        $.ajax({
                type: "post",
                data: $("#editType-dialog").serialize(),
                url: '@Url.Action("BusinessTrip_VisitSubjectEdit", "BusinessTrip")',
                dataType: "json",
                cache: false,
                async: true,
                success: function (data) {
                    if (data.success) {
                        alert(data.msg);
                        $("#editType-dialog").dialog("close");
                        window.location.reload();
                    } else {
                        alert(data.msg);
                    }
                    //console.log(data);
                },
                error: function (err) {
                    alert("点击过快或网络错误，请稍后重试！");;
                    console.log(err);
                }

            })

            }
        }
    });
    //行内修改拜访对象
    function EditType(_this) {
        var cityid = $.trim($(_this).parents().find(".cityId").text()),//城市id
            id = $.trim($(_this).parent().siblings(".planIdF").text());//计划详情id
        visitTypeIdF = $.trim($(_this).parent().siblings(".visitTypeIdF").text()); //拜访详情Id
            visitObjIDF = $.trim($(_this).parent().siblings(".visitObjIDF").text());//拜访对象Id
            visitTypeNameF = $.trim($(_this).parent().siblings(".visitTypeNameF").text());//拜访对象名称
            visitTypeF = $.trim($(_this).parent().siblings(".visitTypeF").text());//拜访对象类型

        common($("#TypeE option"), visitTypeF)
        $("#lastObjName input").val(visitObjIDF);
        $("#lastObjName span").text(visitTypeNameF);
        $("#visitTypeIdE").val(visitTypeIdF);

        $("#TypeAId-cityE").val(cityid);
        $("#TypeAplanIdE").val(id);
        $("#editType-dialog").dialog("open");
    }

    //删除行内拜访对象
    function DelType(_this) {
        var id = $.trim($(_this).parent().siblings(".visitTypeIdF").text()),
             del = $(_this).parent().parent();
        $.ajax({
            type: "post",
            data: { id: id },
            url: '@Url.Action("BusinessTrip_VisitSubjectDel", "BusinessTrip")',
            dataType: "json",
            cache: false,
            async: true,
            success: function (data) {
                //console.log(data);
                if (data.success) {
                    alert(data.msg);
                    $(del).remove();
                } else {
                    alert(data.msg);
                }

            },
            error: function (err) {
                alert("点击过快或网络错误，请稍后重试！");;
                console.log(err);
            }
        })
    }
    //修改计划详情
    function EditMain(_this) {

        var Id = $.trim($(_this).parent().siblings(".Id").text()),
            planId = $.trim($(_this).parent().siblings(".planId").text()),
            Cdate = $.trim($(_this).parent().siblings(".Cdate").text()),
            cityId = $.trim($(_this).parent().siblings(".cityId").text()),
            city = $.trim($(_this).parent().siblings(".city").text()),
            person = $.trim($(_this).parent().siblings(".person").text()),
            visitAim = $.trim($(_this).parent().siblings(".visitAim").text()),
            workPlan = $.trim($(_this).parent().siblings(".workPlan").text()),
            workContent = $.trim($(_this).parent().siblings(".workContent").text()),
            notes = $.trim($(_this).parent().siblings(".notes").text());
        $("#lastCity input").val(cityId);
        $("#lastCity span").text(city);
        $("#editId").val(Id);
        $("#planId").val(planId);
        $("#CdateE").val(Cdate);
        $("#personE").val(person);
        $("#visitAimE").val(visitAim);
        $("#workPlanE").val(workPlan);
        $("#workContentE").val(workContent);
        $("#notesE").val(notes);

        $("#dialog-formE").dialog("open");
    }
    //修改计划详情 配置模态框
    $("#dialog-formE").dialog({
        autoOpen: false,
        height: 800,
        width: 960,
        modal: true,
        buttons: {

            "取消": function () { $(this).dialog("close") },
            "确认": function () {
                var statusD = false;
                $("#editForm .red").each(function (i, m) {
                    if (m.value == "" || m.value == null) {
                        return statusD = true;
                    }
                })
                if (statusD) {
                    alert("必填项不能为空！");
                } else {

                    $.ajax({
                        type: "post",
                        data: $("#editForm").serialize(),
                        url: '@Url.Action("BusinessTrip_DetailsEdit", "BusinessTrip")',
                        dataType: "json",
                        cache: false,
                        async: true,
                        success: function (data) {
                            console.log(data)
                            if (data.success) {
                                $("#dialog-form").dialog("close");
                                alert(data.msg);
                                window.location.reload();
                            } else {
                                alert(data.msg);
                            }
                        },
                        error: function (err) {
                            alert("点击过快或网络错误，请稍后重试！");;
                            console.log(err);
                        }

                    })
                }

            }
        }
    });
    //删除计划详情
    function DelMain(_this) {
        var id = $.trim($(_this).parent().siblings(".planId").text()),
            del = $(_this).parent().parent();
        $.ajax({
            url: '@Url.Action("BusinessTrip_DetailsDel", "BusinessTrip")',
            type: "get",
            data:{id:id},

            dataType: "json",
            cache: false,
            async: true,
            success: function (data) {
                console.log(data)
                if (data.success) {
                    $(del).remove();
                    alert(data.msg);
                } else {
                    alert(data.msg);
                }
            },
            error: function (err) {
                alert("点击过快或网络错误，请稍后重试！");;
                console.log(err);
            }

        })
    }

    //添加拜访对象 选择对象类型后触发
    function chooseObj(_this) {
        //console.log($(_this).parent().next().children(".visitObj"));

        var Val = $(_this).val(),
            visitObj = $(_this).parent().next().children(".visitObj");//获取需要填充的下拉框
        visitObj.empty();
        visitObj.append("<option value=''>-请选择-</option>");
        if (Val == "门店") {
            //调用获取门店的函数
            getStore($("#shi").val(), visitObj)
            return;
        }
        if (Val == "经销商") {
            //调用获取经销商的函数

            getDealer($("#shi").val(),visitObj);
            return;
        }
        if (Val == "商场") {
            //调用获取门店的函数

            getMarket($("#shi").val(),visitObj);
            return;
        }

    }
    //行内添加
    //添加拜访对象 选择对象类型后触发
    function chooseObjA(_this) {
        var Val = $(_this).val(),
            visitObj = $("#ObjName");//获取需要填充的下拉框
        visitObj.empty();
        visitObj.append("<option value=''>-请选择-</option>");
        if (Val == "门店") {
            //调用获取门店的函数
            getStore($("#TypeAId-city").val(), visitObj);
            return;
        }
        if (Val == "经销商") {
            //调用获取经销商的函数
            getDealer($("#TypeAId-city").val(), visitObj);
            return;
        }
        if (Val == "商场") {
            //调用获取门店的函数
            getMarket($("#TypeAId-city").val(), visitObj);
            return;
        }

    }
    //行内修改
    //修改拜访对象 选择对象类型后触发
    function chooseObjE(_this) {
        var Val = $(_this).val(),
            visitObj = $("#ObjNameE");//获取需要填充的下拉框
        visitObj.empty();
        visitObj.append("<option value=''>-请选择-</option>");
        //清空上次选中的
        $("#lastObjName input").val("");
        $("#lastObjName span").text("");

        if (Val == "门店") {
            //调用获取门店的函数
            getStore($("#TypeAId-cityE").val(), visitObj);
            return;
        }
        if (Val == "经销商") {
            //调用获取经销商的函数
            getDealer($("#TypeAId-cityE").val(), visitObj);
            return;
        }
        if (Val == "商场") {
            //调用获取门店的函数
            getMarket($("#TypeAId-cityE").val(), visitObj);
            return;
        }

    }
    //行内修改变化
    $("#ObjNameE").change(function () {
        $("#lastObjName input").val($("#ObjNameE").val());
    })
    //获取门店
    function getStore(id, _sel) {

        $.ajax({
            url: '@Url.Action("GetTripObj", "BusinessTrip")',
            type: "post",
            data: {id:id},
            dataType: "json",
            cache: false,
            async: true,
             success: function (data) {
                 console.log(data);
                 $.each(data.data, function (i, m) {
                     $(_sel).append("<option value=" + m[0] + ">" + m[1]+"</option>");
                })
            },
            error: function (err) {
                alert("点击过快或网络错误，请稍后重试！");;
                console.log(err);
            }

        })
    }

     //获取 经销商
    function getDealer(id, _sel) {
        $.ajax({
            url: "@Url.Action("GetFranchiser", "DevelopmentDoc")",
            type: "post",
            data: { cid:id},
            dataType: "json",
            cache: false,
            async: true,
             success: function (data) {
                 console.log(data);

                 $.each(data, function (i, m) {
                     $(m).each(function (a, b) {
                         _sel.append("<option value=" + b.ID + ">" + b.Name + "</option>");
                     })
                })

            },
            error: function (err) {
                alert("点击过快或网络错误，请稍后重试！");;
                console.log(err);
            }

        })
    }

     //获取 商场
    function getMarket(id,_sel) {
        $.ajax({
            url: "@Url.Action("GetMarket", "DevelopmentDoc")",
            type: "post",
            data: { cid:id},
            dataType: "json",
            cache: false,
            async: true,
             success: function (data) {
                 console.log(data);

                 $.each(data, function (i, m) {
                     $(m).each(function (a,b) {

                         _sel.append("<option value=" + b.ID + ">" + b.Name +"</option>");
                     })

                })

            },
            error: function (err) {
                alert("点击过快或网络错误，请稍后重试！");;
                console.log(err);
            }

        })
    }
       //获取省份数据
        $.ajax({
            type: "post",
            data: {},
            url: '@Url.Action("GetProvince", "DevelopmentDoc")',
            dataType: "json",
            cache: false,
            async: true,
            success: function (data) {
                $.each(data, function(i, m) {
                    $("#sheng").append("<option value=" + m + ">" + m + "</option>")
                    $("#shengE").append("<option value=" + m + ">" + m + "</option>")

                })

            },
            error: function (err) {
                alert("点击过快或网络错误，请稍后重试！");;
                console.log(err);
            }

        })
        //添加 根据选择的省份，获取市数据
        $("#sheng").change(function () {

            var province = $("#sheng").val();
            $("#shi").empty();
            getCity(province, $("#shi"))
        })

    function getCity(province,city) {
         $.ajax({
                type: "post",
                data: { province: province },
                url: '@Url.Action("GetRgion", "DevelopmentDoc")',
                dataType: "json",
                cache: false,
                async: true,
                success: function (data) {
                   // console.log(data)
                    city.append("<option value='' class='active'> -请选择- </option>");
                    $.each(data, function (i, m) {

                        city.append("<option value=" + m[0].ID + ">" + m[0].City + "</option>")

                    })

                },
                error: function (err) {
                    alert("点击过快或网络错误，请稍后重试！");;
                    console.log(err);
                }

            })
    }

        // 行删除
        function Delete(id) {
            if (confirm("确定删除当前数据?")) {
                $.ajax({
                url: "@Url.Action("", "BusinessTrip")",
                type: "get",
                data: { id: id },
                dataType: 'json',
                cache: false,
                error: function (textStatus, errorThrown) { alert("交互错误" + JSON.stringify(textStatus)); },
                success: function (data) {
                    if (data.success) {
                    $("#grid").jqGrid("delRowData", id);
                    alert(data.msg);

                } else {
                        alert("删除失败！");
                        console.log(data.msg);
                }
                }
            });
            }
    };

    //修改时给下拉框添加.selected
    function common(option, Name) {

        if (Name != "" || Name != null) {
            var options = option;
            $(options).each(function (i, m) {
                if (Name == m.value) {

                    $(m).attr("selected", "selected")
                }
            })
        }
    }
    // 跳转详情
    function goDetail() {
        window.location.href = '@Url.Action("BusinessTrip_DetailsView", "BusinessTrip")?id=@ViewBag.ID' ;
    }
    </script>
}
else
{
    {
        ViewBag.Title = "出差记录详情";

    }
    <style>
        .table tbody tr td:nth-child(2n-1) {
            width: auto !important;
        }
    </style>
    <h3>出差记录详情</h3>
    @Html.ActionLink("修改出差记录/添加汇报", "BusinessTrip_DetailsView", "BusinessTrip", new { id = Model.ID, isEdit = true }, new { style = "margin-left:2.5%;" })
    <input type="button" onclick="exl()" value="导出PDF" style="margin-left:2.5%;" />
    <table class="table table-bordered table-hover table-striped Tabwidth-auto pDF-Tab" style="margin-bottom:1px;" id="Table">
        <tr>
            <td class="bold">出差人</td>
            <td colspan="11">@Model.出差人姓名</td>
        </tr>
        <tr>
            <td class="bold">部门</td>
            <td colspan="11">@Model.部门</td>
        </tr>
        <tr>
            <td colspan="12" style="position:relative;">
                <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12 start-date">
                    <span class="bold">开始日期</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="date">@Model.开始时间.ToString("d")</span>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
                    <span class="bold">结束日期</span>&nbsp;&nbsp;&nbsp;&nbsp;<span>@Model.结束时间.ToString("d")</span>
                </div>
            </td>
        </tr>
        <tr>
            <td class="bold">关联审核人</td>
            <td colspan="11">@Model.关联审核人</td>
        </tr>
        <tr>
            <td class="bold">出差内容</td>
            <td colspan="11">@Model.出差内容</td>
        </tr>
        <tr>
            <td class="bold">备注</td>
            <td colspan="11">@Model.备注</td>
        </tr>
        <tr>
            <td class="bold" rowspan="3">费用预估</td>
        </tr>
        <tr>
            <td class="bold">车船费预计</td>
            <td colspan="3">@Model.车船费预计</td>
            <td class="bold">住宿费预计</td>
            <td colspan="3">@Model.住宿费预计</td>
            <td class="bold">餐补费预计</td>
            <td colspan="3">@Model.餐补费预计</td>
        </tr>
        <tr>
            <td class="bold">合计</td>
            <td colspan="10">@Model.合计</td>
        </tr>
        <tr>
            <td class="bold">审核状态</td>
            <td colspan="11">
                @if (Model.审核状态 == true)
                {
                    <span>通过</span>
                }
                else if (Model.审核状态 == false)
                {
                    <span>驳回</span>
                }
                else
                {
                    <span>未审核</span>
                }
            </td>
        </tr>
        @*计划详情表*@
        <tr>
            <td colspan="12" class="text-center bold">计划详情</td>
        </tr>
        <tr>
            <td colspan="12" class="text-center">

                @Html.Action("AddBusinessTrip_DetailsView", "BusinessTrip", new { id = Model.ID, isDetail = true, isEdit = false })
            </td>
        </tr>
        @*<tr class="text-center" id="planDetail-tab">
                <td>ID</td>
                <td>日期</td>
                <td>城市</td>
                <td>经销商</td>
                <td>商场</td>
                <td>门店</td>
                <td>同行人</td>
                <td>巡店目的</td>
                <td>计划方案</td>
                <td>计划内容</td>
                <td>备注</td>
                <td>提交时间</td>
            </tr>*@
        <tr><td colspan="12" class="text-center bold">汇报详情</td></tr>
        <tr class="text-center" id="rport-tab">
            <td>出差计划关联ID</td>
            <td>巡店开始时间</td>
            <td>巡店结束时间</td>
            <td>工作成果</td>
            <td>实际遇到的问题</td>
            <td>解决的方案</td>
            <td>需要的协助</td>
            <td>预计完成时间</td>
            <td>备注</td>
            <td>提交时间</td>
            <td>更新时间</td>
            <td>是否为新增项</td>
        </tr>

    </table>




    if (Model.审核状态 == true)
    {
        <div style="text-align:center;">
            @Html.ActionLink("报销", "ApplyTravelReimbursementView", "Reimbursement", new { id = Model.ID, reimbursementType = "出差" }, new { @class = "btn btn-success" })

        </div>
    }
    else
    {
        <div class="text-center " style="margin-top:10px;">
            <input type="button" name="" value="报销" class="btn" disabled /><span class="orange">未审核不能报销</span>
        </div>
    }
    <script>
    @*//获取计划详情数据
     $.ajax({
        url: '@Url.Action("GetBusinessTrip_Details", "BusinessTrip")',
        type: "post",
        data: {id:@Model.ID},
        dataType: "json",
        cache: false,
        async: true,
         success: function (data) {
            //console.log(data)
            var detailTab = '';
            $.each(data, function(i, m) {
                // 转换日期格式
                m.提交时间 = new Date(parseInt(m.提交时间.substr(6, 19))).toLocaleDateString();
                m.出差时间 = new Date(parseInt(m.出差时间.substr(6, 19))).toLocaleDateString();
                detailTab += "<tr ><td>" + m.ID + "</td><td>" + m.出差时间 + "</td><td>" + m.城市 + "</td><td>"
                    + m.经销商 + "</td><td>" + m.商场 + "</td><td>" + m.门店 + "</td><td>" + m.同行人员+ "</td><td>"
                    + m.巡店目的 + "</td><td>" + m.计划方案 + "</td><td>" + m.计划内容 + "</td><td>" + m.备注 + "</td><td>" + m.提交时间 + "</td></tr>";
            })
             $("#planDetail-tab").after(detailTab);
             clearNull($("#Table td"));
        },
        error: function (err) {
            alert("点击过快或网络异常！");
            console.log(err);
        }

    })*@
    //获取汇报详情数据
     $.ajax({
        url: '@Url.Action("BusinessTrip_RportList", "BusinessTrip")',
        type: "post",
         data: { tripID:@Model.ID},
        dataType: "json",
        cache: false,
        async: true,
         success: function (data) {
            // console.log(data)
            var detailTab = '';
            $.each(data, function(i, m) {
                // 转换日期格式  	   	 提交时间
                if (m.巡店开始时间!=null) {
                    m.巡店开始时间 = new Date(parseInt(m.巡店开始时间.substr(6, 19))).toLocaleString();
                }
                if (m.巡店结束时间 != null) {
                    m.巡店结束时间 = new Date(parseInt(m.巡店结束时间.substr(6, 19))).toLocaleString();
                }
                if (m.提交时间 != null) {
                    m.提交时间 = new Date(parseInt(m.提交时间.substr(6, 19))).toLocaleDateString();
                }
                if (m.更新时间 != null) {
                    m.更新时间 = new Date(parseInt(m.更新时间.substr(6, 19))).toLocaleDateString();
                }
                if (m.预计完成时间 != null) {
                    m.预计完成时间 = new Date(parseInt(m.预计完成时间.substr(6, 19))).toLocaleDateString();
                }


                detailTab += "<tr><td>" + m.出差关联计划项ID + "</td><td>" + m.巡店开始时间 + "</td><td>"
                    + m.巡店结束时间 + "</td><td>" + m.工作成果 + "</td><td>" + m.实际遇到的问题 + "</td><td>" + m.解决的方案+ "</td><td>"
                    + m.需要的协助 + "</td><td>" + m.预计完成时间 + "</td><td>" + m.备注 + "</td><td>" + m.提交时间 + "</td><td>" + m.更新时间 + "</td><td class='text-center'>" + m.是否为新增项 + "</td></tr>";
            })
             $("#rport-tab").after(detailTab);
             clearNull($("#Table td"));
        },
        error: function (err) {
            alert("点击过快或网络异常！");
            console.log(err);
        }

        })

        function exl() {
            str = "@Model.部门-@Model.出差人姓名-出差详情表";
            makeMpdf(str);
        }
    </script>
}


